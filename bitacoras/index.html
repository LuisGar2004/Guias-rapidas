<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Mantenimiento - Hospital UVM</title>
    
    <!-- Bibliotecas para exportación Word -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Calibri', Arial, sans-serif;
            font-size: 11pt;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-around;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #667eea;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        
        .step::after {
            content: '→';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ccc;
        }
        
        .step:last-child::after {
            content: '';
        }
        
        .step.active {
            color: #667eea;
            font-weight: bold;
        }
        
        .step.completed {
            color: #28a745;
        }
        
        .maintenance-type-selector,
        .orden-servicio-section,
        .vista-previa-section {
            background: #f8f9fa;
            padding: 30px;
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .section-header h3 {
            color: #1e3c72;
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .type-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .type-btn {
            background: white;
            border: 3px solid #e1e5e9;
            padding: 20px 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 200px;
        }
        
        .type-btn:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }
        
        .type-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .ordenes-previas-section {
            background: white;
            padding: 30px;
            margin: 20px;
            border-radius: 12px;
            border: 2px solid #667eea;
        }
        
        .orden-card {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .orden-card.correctivo {
            border-left-color: #dc3545;
        }
        
        .orden-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .orden-info {
            flex: 1;
        }
        
        .orden-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .orden-folio {
            font-size: 18px;
            font-weight: bold;
            color: #1e3c72;
        }
        
        .orden-tipo-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .badge-preventivo {
            background: #667eea;
        }
        
        .badge-correctivo {
            background: #dc3545;
        }
        
        .orden-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
            font-size: 13px;
        }
        
        .orden-detail {
            display: flex;
            gap: 5px;
        }
        
        .orden-detail strong {
            color: #1e3c72;
        }
        
        .orden-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-left: 20px;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: transform 0.2s ease;
            white-space: nowrap;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-view {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: transform 0.2s ease;
        }
        
        .btn-view:hover {
            transform: translateY(-2px);
        }

        .form-section {
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            background: white;
        }
        
        .form-section h3 {
            margin: 0 0 15px 0;
            color: #1e3c72;
            font-size: 16px;
            border-bottom: 2px solid #1e3c72;
            padding-bottom: 8px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-field.full-width {
            grid-column: 1 / -1;
        }
        
        .form-field label {
            font-weight: bold;
            color: #1e3c72;
            font-size: 12px;
        }
        
        .form-field input,
        .form-field select,
        .form-field textarea {
            padding: 8px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s ease;
            font-family: 'Calibri', Arial, sans-serif;
        }
        
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-field textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-size: 14px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }
        
        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            color: #155724;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .document-view {
            background: white;
            padding: 20px;
            font-family: 'Calibri', Arial, sans-serif;
            line-height: 1.6;
        }

        .doc-title {
            font-size: 18pt;
            font-weight: bold;
            color: #1e3c72;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 3px solid #1e3c72;
            padding-bottom: 10px;
        }

        .doc-subtitle {
            font-size: 12pt;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }

        .info-section {
            margin: 20px 0;
        }

        .section-title {
            background: #1e3c72;
            color: white;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 12pt;
            margin: 20px 0 10px 0;
        }

        .section-title.correctivo {
            background: #dc3545;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            align-items: baseline;
        }

        .info-label {
            font-weight: bold;
            min-width: 200px;
            color: #1e3c72;
        }

        .info-value {
            flex: 1;
            border-bottom: 1px solid #ccc;
            padding: 2px 5px;
        }

        .activities-list {
            margin: 10px 0 10px 20px;
        }

        .activities-list li {
            margin: 5px 0;
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        .equipment-management {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            justify-content: center;
        }
        
        .add-equipment-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: bold;
        }
        
        .add-equipment-btn:hover {
            transform: translateY(-1px);
        }

        .edit-equipment-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.2s ease;
            font-weight: bold;
        }
        
        .edit-equipment-btn:hover {
            transform: translateY(-1px);
        }

        .equipment-count {
            font-size: 11px;
            color: #666;
            margin-left: 10px;
        }

        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-field label {
            font-weight: bold;
            color: #1e3c72;
            font-size: 12px;
        }
        
        .input-field input, .input-field select, .input-field textarea {
            padding: 8px 10px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 12px;
            transition: border-color 0.3s ease;
        }
        
        .input-field input:focus, .input-field select:focus, .input-field textarea:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .list-input {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            background: #f8f9fa;
        }
        
        .list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
        }
        
        .list-item input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 12px;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        
        .add-item-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 8px;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 20px;
            border-top: 1px solid #e1e5e9;
        }
        
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        @media print {
            body { background: white; padding: 0; }
            .maintenance-type-selector, .orden-servicio-section, .actions, .step-indicator, .ordenes-previas-section, .btn { display: none; }
            .container { box-shadow: none; border-radius: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 SISTEMA DE GESTIÓN DE MANTENIMIENTO</h1>
            <p>Equipos Médicos Especializados - Hospital UVM</p>
        </div>
        
        <!-- INDICADOR DE PASOS -->
        <div class="step-indicator">
            <div class="step active" id="step1">
                <div>PASO 1</div>
                <div style="font-size: 11px;">Historial de Órdenes</div>
            </div>
            <div class="step" id="step2">
                <div>PASO 2</div>
                <div style="font-size: 11px;">Nueva Orden</div>
            </div>
            <div class="step" id="step3">
                <div>PASO 3</div>
                <div style="font-size: 11px;">Vista Previa</div>
            </div>
        </div>
        
        <!-- PASO 1: HISTORIAL DE ÓRDENES -->
        <div class="maintenance-type-selector" id="maintenanceTypeSelector">
            <div class="section-header">
                <h3>📂 Historial de Órdenes de Servicio</h3>
                <p style="color: #666;">Visualice o descargue las órdenes previas / Cree nuevas órdenes</p>
            </div>
            
            <div class="type-buttons">
                <div class="type-btn" onclick="mostrarNuevaOrden('preventivo')">
                    <h4>🔧 NUEVA ORDEN PREVENTIVA</h4>
                    <p>Crear mantenimiento programado</p>
                </div>
                <div class="type-btn" onclick="mostrarNuevaOrden('correctivo')">
                    <h4>🚨 NUEVA ORDEN CORRECTIVA</h4>
                    <p>Reportar falla o reparación</p>
                </div>
            </div>
            
            <div class="ordenes-previas-section">
                <h3 style="color: #1e3c72; margin-bottom: 15px;">📋 Órdenes de Servicio Previas</h3>
                <div id="ordenesPreviasContainer">
                    <!-- Las órdenes previas se cargarán dinámicamente aquí -->
                </div>
            </div>
        </div>

        <!-- PASO 2: NUEVA ORDEN DE SERVICIO -->
        <div class="orden-servicio-section hidden" id="ordenServicioSection">
            <h2 style="text-align: center; color: #1e3c72; margin-bottom: 20px;" id="tituloNuevaOrden">
                📄 NUEVA ORDEN DE SERVICIO
            </h2>
            
            <div class="alert-info">
                <strong>ℹ️ Información:</strong> Complete los datos para generar la orden de servicio. Todos los campos marcados con (*) son obligatorios.
            </div>
            
            <form id="ordenServicioForm">
                <input type="hidden" id="tipoMantenimiento" value="">
                
                <div class="form-section">
                    <h3>👤 Datos del Técnico Responsable</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label>Nombre Completo *</label>
                            <input type="text" id="tecnicoNombre" required>
                        </div>
                        <div class="form-field">
                            <label>Cédula Profesional</label>
                            <input type="text" id="tecnicoCedula">
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>🔧 Información del Equipo</h3>
                    <div class="form-field">
                        <label>Seleccionar Equipo *</label>
                        <select id="equipoSelect" required onchange="cargarDatosEquipo()">
                            <option value="">-- Seleccionar Equipo --</option>
                        </select>
                    </div>
                    <div id="equipoDetalles" class="hidden" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <div class="form-grid">
                            <div class="form-field">
                                <label>Nombre del Equipo</label>
                                <input type="text" id="equipoNombre" readonly>
                            </div>
                            <div class="form-field">
                                <label>Modelo</label>
                                <input type="text" id="equipoModelo" readonly>
                            </div>
                            <div class="form-field">
                                <label>Fabricante/Marca</label>
                                <input type="text" id="equipoFabricante" readonly>
                            </div>
                            <div class="form-field">
                                <label>Número de Serie</label>
                                <input type="text" id="equipoSerie" readonly>
                            </div>
                            <div class="form-field">
                                <label>Código de Inventario</label>
                                <input type="text" id="equipoInventario" readonly>
                            </div>
                            <div class="form-field">
                                <label>Ubicación</label>
                                <input type="text" id="equipoUbicacion" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="equipment-management">
                        <button type="button" class="add-equipment-btn" onclick="abrirModalAgregarEquipo()">➕ Agregar Nuevo Equipo</button>
                        <button type="button" class="edit-equipment-btn" onclick="abrirModalEditarEquipo()">✏️ Editar Equipo</button>
                        <span class="equipment-count" id="equipmentCount">5 equipos registrados</span>
                    </div>
                </div>
                
                <!-- Campos específicos para PREVENTIVO -->
                <div class="form-section hidden" id="camposPreventivo">
                    <h3>📅 Datos del Mantenimiento Preventivo</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label>Fecha Programada *</label>
                            <input type="date" id="fechaProgramada">
                        </div>
                        <div class="form-field">
                            <label>Tipo de Mantenimiento *</label>
                            <select id="tipoMttoPreventivo">
                                <option value="">-- Seleccionar --</option>
                                <option value="Mensual">Mensual</option>
                                <option value="Trimestral">Trimestral</option>
                                <option value="Semestral">Semestral</option>
                                <option value="Anual">Anual</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Prioridad *</label>
                            <select id="prioridadPreventivo">
                                <option value="">-- Seleccionar --</option>
                                <option value="Baja">Baja</option>
                                <option value="Media">Media</option>
                                <option value="Alta">Alta</option>
                                <option value="Crítica">Crítica</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Tiempo Estimado (horas) *</label>
                            <input type="number" id="tiempoEstimado" step="0.5" placeholder="Ej: 2.5">
                        </div>
                        <div class="form-field full-width">
                            <label>Actividades a Realizar *</label>
                            <textarea id="actividadesPreventivo" placeholder="Lista de actividades del mantenimiento preventivo, una por línea"></textarea>
                        </div>
                        <div class="form-field full-width">
                            <label>Materiales Necesarios</label>
                            <textarea id="materialesPreventivo" placeholder="Lista de materiales y herramientas necesarias"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- Campos específicos para CORRECTIVO -->
                <div class="form-section hidden" id="camposCorrectivo">
                    <h3>🚨 Información de la Falla</h3>
                    <div class="form-grid">
                        <div class="form-field">
                            <label>Usuario que Reporta *</label>
                            <input type="text" id="usuarioReporta" placeholder="Nombre completo">
                        </div>
                        <div class="form-field">
                            <label>Fecha del Incidente *</label>
                            <input type="datetime-local" id="fechaIncidente">
                        </div>
                        <div class="form-field">
                            <label>Prioridad *</label>
                            <select id="prioridadCorrectivo">
                                <option value="">-- Seleccionar --</option>
                                <option value="Baja">Baja (1 semana)</option>
                                <option value="Media">Media (72h)</option>
                                <option value="Alta">Alta (24h)</option>
                                <option value="Crítica">Crítica (Inmediata)</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>Síntomas Observados *</label>
                            <input type="text" id="sintomas" placeholder="Breve descripción">
                        </div>
                        <div class="form-field full-width">
                            <label>Descripción del Problema *</label>
                            <textarea id="descripcionProblema" placeholder="Descripción detallada de la falla reportada"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" class="btn btn-secondary" onclick="volverAlInicio()">← Volver</button>
                    <button type="submit" class="btn btn-warning">👁️ Vista Previa →</button>
                </div>
            </form>
        </div>

        <!-- PASO 3: VISTA PREVIA -->
        <div class="vista-previa-section hidden" id="vistaPreviaSection">
            <h2 style="text-align: center; color: #1e3c72; margin-bottom: 20px;">
                👁️ VISTA PREVIA DE DOCUMENTOS
            </h2>
            
            <div class="alert-info">
                <strong>ℹ️ Información:</strong> Revise los documentos antes de guardar. <span id="folioPreview"></span>
            </div>

            <div class="document-view" id="documentosPreview"></div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="volverAFormulario()">← Editar</button>
                <button class="btn btn-success" onclick="guardarOrden()">💾 Guardar Orden</button>
            </div>
        </div>
    </div>

    <!-- Modal para visualización de órdenes previas -->
    <div id="docModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Documento</h2>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="documentContent" class="document-view"></div>
            </div>
        </div>
    </div>

    <!-- Modal para agregar equipo -->
    <div id="addEquipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <h2>➕ Agregar Nuevo Equipo Médico</h2>
                <span class="close" onclick="cerrarModalAgregarEquipo()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="newEquipmentForm">
                    <div class="form-section">
                        <h3>📋 Información Básica del Equipo</h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Nombre del Equipo *</label>
                                <input type="text" id="equipName" required placeholder="Ej: Electrocardiógrafo">
                            </div>
                            <div class="input-field">
                                <label>Marca/Fabricante *</label>
                                <input type="text" id="equipBrand" required placeholder="Ej: GE Healthcare">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Modelo *</label>
                                <input type="text" id="equipModel" required placeholder="Ej: MAC 2000">
                            </div>
                            <div class="input-field">
                                <label>Número de Serie *</label>
                                <input type="text" id="equipSerial" required placeholder="Ej: SN-2024-1234">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Código de Inventario *</label>
                                <input type="text" id="equipInventory" required placeholder="Ej: HOSPI-CARD-001">
                            </div>
                            <div class="input-field">
                                <label>Ubicación *</label>
                                <input type="text" id="equipLocation" required placeholder="Ej: Consultorio 1 - Cardiología">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Especialidad/Área</label>
                                <select id="equipSpecialty">
                                    <option value="Cardiología">Cardiología</option>
                                    <option value="Radiología">Radiología</option>
                                    <option value="Laboratorio">Laboratorio</option>
                                    <option value="Fisioterapia/Electroterapia">Fisioterapia/Electroterapia</option>
                                    <option value="Oftalmología">Oftalmología</option>
                                    <option value="Otorrinolaringología">Otorrinolaringología</option>
                                    <option value="Cirugía">Cirugía</option>
                                    <option value="Emergencias">Emergencias</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="input-field">
                                <label>Clase de Riesgo</label>
                                <select id="equipRisk">
                                    <option value="I">Clase I (Bajo riesgo)</option>
                                    <option value="IIA">Clase IIA (Medio riesgo)</option>
                                    <option value="IIB">Clase IIB (Medio-alto riesgo)</option>
                                    <option value="III">Clase III (Alto riesgo)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3>🔧 Actividades de Mantenimiento Preventivo</h3>
                        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                            Agregue las actividades específicas que se deben realizar durante el mantenimiento preventivo
                        </p>
                        <div class="list-input" id="activitiesList">
                            <div class="list-item">
                                <input type="text" placeholder="Ej: Inspección visual externa del equipo" value="Inspección visual general del equipo">
                                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
                            </div>
                            <div class="list-item">
                                <input type="text" placeholder="Ej: Verificación de funcionamiento básico" value="Verificación de funcionamiento básico">
                                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addActivity()">➕ Agregar Actividad</button>
                    </div>
                    
                    <div class="form-section">
                        <h3>📊 Mediciones y Parámetros Técnicos</h3>
                        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                            Defina los parámetros que se deben medir y verificar
                        </p>
                        <div id="measurementsList">
                            <div class="list-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: center;">
                                <input type="text" placeholder="Parámetro (Ej: Voltaje de entrada)" value="Voltaje de entrada">
                                <input type="text" placeholder="Especificación (Ej: 220V ±10%)" value="220V ±10%">
                                <input type="text" placeholder="Unidad (V, mA, Hz, etc.)" value="V">
                                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addMeasurement()">➕ Agregar Medición</button>
                    </div>
                    
                    <div class="form-section">
                        <h3>🚨 Síntomas Comunes (Mantenimiento Correctivo)</h3>
                        <p style="font-size: 11px; color: #666; margin-bottom: 10px;">
                            Liste los síntomas o fallas más comunes que pueden presentarse
                        </p>
                        <div class="list-input" id="symptomsList">
                            <div class="list-item">
                                <input type="text" placeholder="Ej: Equipo no enciende" value="Equipo no enciende">
                                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
                            </div>
                            <div class="list-item">
                                <input type="text" placeholder="Ej: Funcionamiento intermitente" value="Funcionamiento intermitente">
                                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addSymptom()">➕ Agregar Síntoma</button>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="cerrarModalAgregarEquipo()">Cancelar</button>
                <button type="button" class="btn-modal btn-save" onclick="guardarNuevoEquipo()">💾 Guardar Equipo</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar equipo -->
    <div id="editEquipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                <h2>✏️ Editar Equipo Médico</h2>
                <span class="close" onclick="cerrarModalEditarEquipo()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h3>📋 Seleccionar Equipo a Editar</h3>
                    <div class="input-field">
                        <label>Equipo *</label>
                        <select id="editEquipmentSelect" onchange="cargarEquipoParaEditar()" style="width: 100%; padding: 8px; border: 2px solid #e1e5e9; border-radius: 6px;">
                            <option value="">-- Seleccionar Equipo --</option>
                        </select>
                    </div>
                </div>
                
                <form id="editEquipmentForm" class="hidden">
                    <div class="form-section">
                        <h3>📋 Información Básica del Equipo</h3>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Nombre del Equipo *</label>
                                <input type="text" id="editEquipName" required>
                            </div>
                            <div class="input-field">
                                <label>Marca/Fabricante *</label>
                                <input type="text" id="editEquipBrand" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Modelo *</label>
                                <input type="text" id="editEquipModel" required>
                            </div>
                            <div class="input-field">
                                <label>Número de Serie</label>
                                <input type="text" id="editEquipSerial">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Código de Inventario</label>
                                <input type="text" id="editEquipInventory">
                            </div>
                            <div class="input-field">
                                <label>Ubicación</label>
                                <input type="text" id="editEquipLocation">
                            </div>
                        </div>
                        <div class="input-group">
                            <div class="input-field">
                                <label>Especialidad/Área</label>
                                <select id="editEquipSpecialty">
                                    <option value="Cardiología">Cardiología</option>
                                    <option value="Radiología">Radiología</option>
                                    <option value="Laboratorio">Laboratorio</option>
                                    <option value="Fisioterapia/Electroterapia">Fisioterapia/Electroterapia</option>
                                    <option value="Oftalmología">Oftalmología</option>
                                    <option value="Otorrinolaringología/Oftalmología">Otorrinolaringología/Oftalmología</option>
                                    <option value="Cirugía">Cirugía</option>
                                    <option value="Emergencias">Emergencias</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="input-field">
                                <label>Clase de Riesgo</label>
                                <select id="editEquipRisk">
                                    <option value="I">Clase I (Bajo riesgo)</option>
                                    <option value="IIA">Clase IIA (Medio riesgo)</option>
                                    <option value="IIB">Clase IIB (Medio-alto riesgo)</option>
                                    <option value="III">Clase III (Alto riesgo)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-modal btn-cancel" onclick="cerrarModalEditarEquipo()">Cancelar</button>
                <button type="button" class="btn-modal btn-save" style="background: #007bff;" onclick="guardarEquipoEditado()">💾 Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let ordenActual = null;
        let contadorOrdenes = 852;
        let equiposPersonalizados = {};
        
        // Base de datos de equipos predeterminados CON MEDICIONES CORRECTAS DEL PDF
        const equipmentDatabase = {
            ultrasonido: {
                name: "Ultrasonido Terapéutico",
                brand: "Chattanooga",
                model: "Intelect Transport 2782",
                serialNumber: "CG-MX2-2023-4871",
                inventoryCode: "HOSPI-FISIO-154",
                specialty: "Fisioterapia/Electroterapia",
                risk: "IIA",
                location: "Fisioterapia - Consultorio 3",
                preventivo: {
                    activities: [
                        "Inspección visual general (estructura, cables, conexiones)",
                        "Verificación de funcionamiento básico",
                        "Limpieza externa e interna según protocolo",
                        "Verificación de parámetros de seguridad eléctrica",
                        "Calibración según especificaciones del fabricante",
                        "Prueba de funcionamiento",
                        "Verificación de alarmas y sistemas de seguridad"
                    ],
                    measurements: [
                        { param: "Voltaje de entrada", spec: "220V ±10%", unit: "V" },
                        { param: "Corriente de fuga", spec: "≤0.5 mA", unit: "mA" },
                        { param: "Resistencia a tierra", spec: "≤0.2 Ω", unit: "Ω" },
                        { param: "Frecuencia ultrasonido", spec: "1MHz ±5%", unit: "MHz" },
                        { param: "Potencia máxima ultrasonido", spec: "3W/cm²", unit: "W/cm²" },
                        { param: "Corriente electroestimulación Canal A", spec: "0-150mA", unit: "mA" },
                        { param: "Corriente electroestimulación Canal B", spec: "0-150mA", unit: "mA" }
                    ]
                },
                correctivo: {
                    commonSymptoms: [
                        "Equipo no enciende",
                        "Sin emisión de ultrasonido",
                        "Pantalla con errores",
                        "Transductor no funciona",
                        "Alarmas intermitentes"
                    ]
                }
            },
            sillon: {
                name: "Sillón Terapéutico",
                brand: "Midmark",
                model: "641 Procedure Chair",
                serialNumber: "MD-2022-3594",
                inventoryCode: "HOSPI-OTOFT-089",
                specialty: "Otorrinolaringología/Oftalmología",
                risk: "I",
                location: "Consultorio Oftalmología",
                preventivo: {
                    activities: [
                        "Inspección visual general (estructura, cables, conexiones)",
                        "Verificación de funcionamiento básico",
                        "Limpieza externa e interna según protocolo",
                        "Lubricación de componentes mecánicos",
                        "Verificación de parámetros de seguridad eléctrica",
                        "Calibración según especificaciones del fabricante",
                        "Prueba de funcionamiento"
                    ],
                    measurements: [
                        { param: "Voltaje de entrada", spec: "220V ±10%", unit: "V" },
                        { param: "Corriente de fuga", spec: "≤0.5 mA", unit: "mA" },
                        { param: "Resistencia a tierra", spec: "≤0.2 Ω", unit: "Ω" },
                        { param: "Capacidad elevación máxima", spec: "180 kg", unit: "kg" },
                        { param: "Tiempo elevación completa", spec: "15-20 seg", unit: "seg" },
                        { param: "Rango inclinación respaldo", spec: "0-85°", unit: "°" }
                    ]
                },
                correctivo: {
                    commonSymptoms: [
                        "No se eleva/baja",
                        "Ruidos anormales",
                        "Movimientos erráticos",
                        "Controles no responden",
                        "Pérdida de presión hidráulica"
                    ]
                }
            },
            estimulador: {
                name: "Estimulador Muscular",
                brand: "Compex",
                model: "SP 4.0 Profesional",
                serialNumber: "CMPX-2023-7829",
                inventoryCode: "HOSPI-FISIO-201",
                specialty: "Fisioterapia/Electroterapia",
                risk: "IIA",
                location: "Fisioterapia - Área Electroterapia",
                preventivo: {
                    activities: [
                        "Inspección visual general (estructura, cables, conexiones)",
                        "Verificación de funcionamiento básico",
                        "Limpieza externa e interna según protocolo",
                        "Verificación de parámetros de seguridad eléctrica",
                        "Calibración según especificaciones del fabricante",
                        "Prueba de funcionamiento",
                        "Verificación de alarmas y sistemas de seguridad"
                    ],
                    measurements: [
                        { param: "Voltaje de entrada", spec: "220V ±10%", unit: "V" },
                        { param: "Corriente de fuga", spec: "≤0.5 mA", unit: "mA" },
                        { param: "Resistencia a tierra", spec: "≤0.2 Ω", unit: "Ω" },
                        { param: "Corriente máxima Canal 1", spec: "0-150 mA", unit: "mA" },
                        { param: "Corriente máxima Canal 2", spec: "0-150 mA", unit: "mA" },
                        { param: "Rango frecuencia TENS", spec: "1-250 Hz", unit: "Hz" },
                        { param: "Ancho de pulso máximo", spec: "50-400 µs", unit: "µs" }
                    ]
                },
                correctivo: {
                    commonSymptoms: [
                        "Sin salida de corriente",
                        "Batería no carga",
                        "Errores de programación",
                        "Electrodos sin adherencia",
                        "Pantalla dañada"
                    ]
                }
            },
            microscopio: {
                name: "Microscopio Quirúrgico",
                brand: "ZEISS",
                model: "PENTERO 800 S",
                serialNumber: "ZS-P800S-2024-1567",
                inventoryCode: "HOSPI-QUIR-127",
                specialty: "Otorrinolaringología/Oftalmología",
                risk: "IIA",
                location: "Quirófano Otorrino/Oftalmología",
                preventivo: {
                    activities: [
                        "Inspección visual general (estructura, cables, conexiones)",
                        "Verificación de funcionamiento básico",
                        "Limpieza externa e interna según protocolo",
                        "Lubricación de componentes mecánicos",
                        "Verificación de parámetros de seguridad eléctrica",
                        "Calibración según especificaciones del fabricante",
                        "Prueba de funcionamiento"
                    ],
                    measurements: [
                        { param: "Voltaje de entrada", spec: "220V ±10%", unit: "V" },
                        { param: "Corriente de fuga", spec: "≤0.5 mA", unit: "mA" },
                        { param: "Resistencia a tierra", spec: "≤0.2 Ω", unit: "Ω" },
                        { param: "Magnificación máxima", spec: "39x", unit: "x" },
                        { param: "Distancia focal apocromática", spec: "200-500 mm", unit: "mm" },
                        { param: "Fluorescencia Infrared 800", spec: ">95%", unit: "%" },
                        { param: "Sistema Flow 800 intensidad", spec: ">90%", unit: "%" }
                    ]
                },
                correctivo: {
                    commonSymptoms: [
                        "Sistema óptico desalineado",
                        "Resolution Enhancer no funciona",
                        "Sistema 4K 3D con fallas",
                        "Distancia trabajo no ajusta",
                        "Iluminación Xenón intermitente",
                        "AutoBalance no calibra"
                    ]
                }
            },
            lampara_hendidura: {
                name: "Lámpara de Hendidura",
                brand: "Topcon",
                model: "SL-D7 Digital Slit Lamp",
                serialNumber: "TP-2023-2148",
                inventoryCode: "HOSPI-OFTAL-168",
                specialty: "Oftalmología",
                risk: "IIA",
                location: "Consultorio Oftalmología",
                preventivo: {
                    activities: [
                        "Inspección visual general (estructura, cables, conexiones)",
                        "Verificación de funcionamiento básico",
                        "Limpieza externa e interna según protocolo",
                        "Lubricación de componentes mecánicos",
                        "Verificación de parámetros de seguridad eléctrica",
                        "Calibración según especificaciones del fabricante",
                        "Prueba de funcionamiento"
                    ],
                    measurements: [
                        { param: "Voltaje de entrada", spec: "220V ±10%", unit: "V" },
                        { param: "Corriente de fuga", spec: "≤0.5 mA", unit: "mA" },
                        { param: "Resistencia a tierra", spec: "≤0.2 Ω", unit: "Ω" },
                        { param: "Magnificación mínima", spec: "6.3x ±5%", unit: "x" },
                        { param: "Magnificación máxima", spec: "40x ±5%", unit: "x" },
                        { param: "Intensidad iluminación máxima", spec: ">95%", unit: "%" },
                        { param: "Alineación óptica horizontal", spec: "≤0.5°", unit: "°" }
                    ]
                },
                correctivo: {
                    commonSymptoms: [
                        "Iluminación no uniforme",
                        "Sistema digital no funciona",
                        "Hendidura no ajusta",
                        "Magnificación incorrecta",
                        "Movimientos trabados"
                    ]
                }
            }
        };

        // Base de datos completa con DATOS REALES
        let ordenesPreviasCompletas = {
            'MP-2025-847': {
                tipo: 'preventivo',
                folio: 'MP-2025-847',
                fecha: '25/11/2025',
                equipo: {
                    nombre: 'Ultrasonido Terapéutico',
                    modelo: 'Intelect Transport 2782',
                    fabricante: 'Chattanooga',
                    serie: 'CG-MX2-2023-4871',
                    ubicacion: 'Sala de Fisioterapia - Área 3',
                    inventario: 'HOSPI-FISIO-154',
                    claseRiesgo: 'IIA'
                },
                orden: {
                    tipoMantenimiento: 'Anual',
                    prioridad: 'Media',
                    tecnico: 'Luis Alfredo García Bernal',
                    supervisor: 'Ing. Luis Adai García Godínez',
                    tiempoEstimado: '2.5 horas',
                    tiempoReal: '2.8 horas'
                },
                parametros: {
                    voltaje: '220.5 V',
                    corrienteFuga: '0.32 mA',
                    resistenciaTierra: '0.15 Ω',
                    frecuenciaUS: '0.998 MHz',
                    potenciaMax: '2.95 W/cm²'
                },
                actividades: [
                    'Inspección visual completa',
                    'Verificación de funcionamiento básico',
                    'Limpieza externa e interna',
                    'Verificación eléctrica completa',
                    'Calibración de frecuencia y corrientes'
                ],
                materialesUtilizados: [
                    'Alcohol isopropílico 70%',
                    'Aire comprimido',
                    'Gel conductor de prueba',
                    'Fusible interno 2A (F2A-250V)'
                ],
                observaciones: 'Cable de alimentación con ligero desgaste en zona de flexión. Transductor en excelente estado.',
                componentesReemplazados: 'Fusible interno 2A (F2A-250V)',
                resultado: 'APROBADO',
                proximaFecha: '25/05/2026'
            },
            'MP-2025-848': {
                tipo: 'preventivo',
                folio: 'MP-2025-848',
                fecha: '27/09/2025',
                equipo: {
                    nombre: 'Sillón Terapéutico',
                    modelo: '641 Procedure Chair',
                    fabricante: 'Midmark',
                    serie: 'MD-2022-3594',
                    ubicacion: 'Consultorio Oftalmología',
                    inventario: 'HOSPI-OTOFT-089',
                    claseRiesgo: 'I'
                },
                orden: {
                    tipoMantenimiento: 'Trimestral',
                    prioridad: 'Baja',
                    tecnico: 'Luis Alfredo García Bernal',
                    supervisor: 'Ing. Ana Patricia Ruiz',
                    tiempoEstimado: '1.5 horas',
                    tiempoReal: '1.5 horas'
                },
                parametros: {
                    voltaje: '218.7 V',
                    corrienteFuga: '0.28 mA',
                    resistenciaTierra: '0.12 Ω',
                    capacidadElevacion: '180 kg',
                    tiempoElevacion: '18.5 seg'
                },
                actividades: [
                    'Inspección visual de estructura y tapizado',
                    'Verificación de controles de elevación',
                    'Limpieza profunda del tapizado',
                    'Lubricación de bisagras',
                    'Calibración de límites de movimiento'
                ],
                materialesUtilizados: [
                    'Desinfectante hospitalario',
                    'Aceite hidráulico especificado',
                    'Paños de microfibra'
                ],
                observaciones: 'Tapizado en excelente estado. Controles funcionando correctamente.',
                componentesReemplazados: 'N/A',
                resultado: 'APROBADO',
                proximaFecha: '01/01/2026'
            },
            'MP-2025-849': {
                tipo: 'preventivo',
                folio: 'MP-2025-849',
                fecha: '27/09/2025',
                equipo: {
                    nombre: 'Estimulador Muscular',
                    modelo: 'SP 4.0 Profesional',
                    fabricante: 'Compex',
                    serie: 'CMPX-2023-7829',
                    ubicacion: 'Sala de Fisioterapia - Consultorio 2',
                    inventario: 'HOSPI-FISIO-201',
                    claseRiesgo: 'IIA'
                },
                orden: {
                    tipoMantenimiento: 'Trimestral',
                    prioridad: 'Media',
                    tecnico: 'Luis Alfredo García Bernal',
                    supervisor: 'Ing. Luis Adai García Godínez',
                    tiempoEstimado: '2.0 horas',
                    tiempoReal: '2.3 horas'
                },
                parametros: {
                    voltaje: '221.2 V',
                    corrienteFuga: '0.31 mA',
                    resistenciaTierra: '0.14 Ω',
                    corrienteCanal1: '149.5 mA',
                    corrienteCanal2: '148.8 mA'
                },
                actividades: [
                    'Inspección visual completa',
                    'Verificación de ambos canales',
                    'Limpieza externa e interna',
                    'Calibración de formas de onda',
                    'Verificación de protocolos'
                ],
                materialesUtilizados: [
                    'Alcohol isopropílico 70%',
                    'Aire comprimido',
                    'Resistencias de carga de prueba',
                    'Electrodos de prueba'
                ],
                observaciones: 'Cables en excelente estado. Sistema de alarmas operativo.',
                componentesReemplazados: 'N/A',
                resultado: 'APROBADO',
                proximaFecha: '02/01/2026'
            },
            'MP-2025-850': {
                tipo: 'preventivo',
                folio: 'MP-2025-850',
                fecha: '27/09/2025',
                equipo: {
                    nombre: 'Microscopio Quirúrgico',
                    modelo: 'PENTERO 800 S',
                    fabricante: 'ZEISS',
                    serie: 'ZS-P800S-2024-1567',
                    ubicacion: 'Quirófano 3 - Otorrinolaringología',
                    inventario: 'HOSPI-QUIR-127',
                    claseRiesgo: 'IIA'
                },
                orden: {
                    tipoMantenimiento: 'Semestral',
                    prioridad: 'Alta',
                    tecnico: 'Luis Alfredo García Bernal',
                    supervisor: 'Ing. Luis Adai García Godínez',
                    tiempoEstimado: '4.5 horas',
                    tiempoReal: '4.8 horas'
                },
                parametros: {
                    voltaje: '219.8 V',
                    corrienteFuga: '0.38 mA',
                    resistenciaTierra: '0.16 Ω',
                    magnificacionMax: '39.2x',
                    distanciaFocal: '350 mm'
                },
                actividades: [
                    'Inspección del sistema óptico',
                    'Limpieza especializada con paños ZEISS',
                    'Lubricación de articulaciones',
                    'Verificación eléctrica completa',
                    'Pruebas de magnificación'
                ],
                materialesUtilizados: [
                    'Paños ópticos certificados ZEISS',
                    'Lubricante especializado para óptica',
                    'Filtro ventilación interna (ZS-FLT-P8)',
                    'Limpiador de lentes especializado'
                ],
                observaciones: 'Sistema óptico en perfectas condiciones. Iluminación LED uniforme.',
                componentesReemplazados: 'Filtro ventilación interna (ZS-FLT-P8)',
                resultado: 'APROBADO',
                proximaFecha: '03/04/2026'
            },
            'MP-2025-851': {
                tipo: 'preventivo',
                folio: 'MP-2025-851',
                fecha: '27/09/2025',
                equipo: {
                    nombre: 'Lámpara de Hendidura',
                    modelo: 'SL-D7 Digital Slit Lamp',
                    fabricante: 'Topcon',
                    serie: 'TP-2023-2148',
                    ubicacion: 'Oftalmología - Consultorio 2',
                    inventario: 'HOSPI-OFTAL-168',
                    claseRiesgo: 'IIA'
                },
                orden: {
                    tipoMantenimiento: 'Trimestral',
                    prioridad: 'Media',
                    tecnico: 'Luis Alfredo García Bernal',
                    supervisor: 'Ing. Luis Adai García Godínez',
                    tiempoEstimado: '2.5 horas',
                    tiempoReal: '2.7 horas'
                },
                parametros: {
                    voltaje: '220.3 V',
                    corrienteFuga: '0.29 mA',
                    resistenciaTierra: '0.13 Ω',
                    magnificacionMin: '6.2x',
                    magnificacionMax: '39.8x'
                },
                actividades: [
                    'Verificación de magnificación',
                    'Limpieza especializada del sistema óptico',
                    'Lubricación de mecanismos',
                    'Verificación de sistema eléctrico',
                    'Ajuste de sistema de mentonera'
                ],
                materialesUtilizados: [
                    'Paños ópticos especiales',
                    'Lubricante para mecanismos de precisión',
                    'Lámpara LED principal (HS-LED-BQ9)',
                    'Limpiador óptico certificado'
                ],
                observaciones: 'Sistema óptico en excelente estado. Iluminación LED uniforme.',
                componentesReemplazados: 'Lámpara LED principal (HS-LED-BQ9)',
                resultado: 'APROBADO',
                proximaFecha: '04/01/2026'
            },
            'MC-2025-234': {
                tipo: 'correctivo',
                folio: 'MC-2025-234',
                fecha: '15/10/2025',
                equipo: {
                    nombre: 'Ultrasonido Terapéutico',
                    modelo: 'Intelect Transport 2782',
                    fabricante: 'Chattanooga',
                    serie: 'CG-MX2-2023-4871',
                    ubicacion: 'Sala de Fisioterapia - Área 3',
                    inventario: 'HOSPI-FISIO-154',
                    claseRiesgo: 'IIA'
                },
                falla: {
                    usuarioReporta: 'Lic. Medellin Serafin Angel Eduardo',
                    fechaIncidente: '14/10/2025 10:45',
                    prioridad: 'Media',
                    descripcion: 'Equipo dejó de emitir ultrasonido. Display muestra valores normales pero no hay vibración en el transductor. Canal de electroestimulación funciona normalmente.',
                    sintomas: 'Sin emisión de ultrasonido'
                },
                diagnostico: {
                    tecnico: 'Luis Alfredo García Bernal',
                    fechaInicio: '15/10/2025 08:30',
                    causaRaiz: 'Componente defectuoso - Cristal piezoeléctrico fracturado',
                    herramientas: 'Multímetro, Hidrofón, Patrones de prueba'
                },
                reparacion: {
                    fechaInicio: '15/10/2025 13:00',
                    fechaFin: '15/10/2025 16:30',
                    procedimientos: [
                        'Desmontaje del transductor',
                        'Verificación del cristal piezoeléctrico',
                        'Reemplazo completo del transductor',
                        'Calibración con phantom de referencia',
                        'Pruebas de potencia con hidrofón'
                    ],
                    componenteDefectuoso: 'Transductor ultrasónico (P/N: CG-TR1M, S/N: TR450291)',
                    componenteNuevo: 'Transductor ultrasónico (P/N: CG-TR1M, S/N: TR450847)',
                    materialesUtilizados: [
                        'Transductor ultrasónico nuevo',
                        'Gel conductor de prueba',
                        'Alcohol isopropílico',
                        'Phantom de calibración'
                    ],
                    costoTotal: '$5,100',
                    tiempoFueraServicio: '30 horas'
                },
                resultado: 'REPARACIÓN COMPLETADA'
            }
        };

        // Inicialización al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            cargarEquiposPersonalizados();
            cargarOrdenesPrevias();
            actualizarSelectoresEquipo();
            actualizarContadorEquipos();
        });

        // Función para cargar equipos personalizados desde localStorage
        function cargarEquiposPersonalizados() {
            const saved = localStorage.getItem('equiposPersonalizados');
            if (saved) {
                equiposPersonalizados = JSON.parse(saved);
            }
            
            // Cargar órdenes previas desde localStorage
            const ordenesGuardadas = localStorage.getItem('ordenesPrevias');
            if (ordenesGuardadas) {
                const ordenesLS = JSON.parse(ordenesGuardadas);
                ordenesPreviasCompletas = {...ordenesPreviasCompletas, ...ordenesLS};
            }
        }

        // Función para guardar equipos personalizados en localStorage
        function guardarEquiposPersonalizados() {
            localStorage.setItem('equiposPersonalizados', JSON.stringify(equiposPersonalizados));
        }

        // Función para guardar órdenes en localStorage
        function guardarOrdenesEnStorage() {
            // Solo guardar las órdenes nuevas (no las predeterminadas)
            const ordenesNuevas = {};
            Object.keys(ordenesPreviasCompletas).forEach(folio => {
                if (parseInt(folio.split('-')[2]) >= 852) {
                    ordenesNuevas[folio] = ordenesPreviasCompletas[folio];
                }
            });
            localStorage.setItem('ordenesPrevias', JSON.stringify(ordenesNuevas));
        }

        // Función para actualizar selectores de equipo
        function actualizarSelectoresEquipo() {
            const selectores = ['equipoSelect', 'editEquipmentSelect'];
            
            selectores.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (!select) return;
                
                // Limpiar opciones (excepto la primera)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Agregar equipos predeterminados
                Object.keys(equipmentDatabase).forEach(key => {
                    const equip = equipmentDatabase[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${equip.name} - ${equip.brand} ${equip.model}`;
                    select.appendChild(option);
                });
                
                // Agregar equipos personalizados
                Object.keys(equiposPersonalizados).forEach(key => {
                    const equip = equiposPersonalizados[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${equip.name} - ${equip.brand} ${equip.model}`;
                    option.className = 'custom-option';
                    select.appendChild(option);
                });
            });
        }

        // Función para actualizar contador de equipos
        function actualizarContadorEquipos() {
            const totalEquipos = Object.keys(equipmentDatabase).length + Object.keys(equiposPersonalizados).length;
            document.getElementById('equipmentCount').textContent = `${totalEquipos} equipos registrados`;
        }

        // Función para cargar órdenes previas
        function cargarOrdenesPrevias() {
            const container = document.getElementById('ordenesPreviasContainer');
            container.innerHTML = '';
            
            // Convertir objeto a array y ordenar por folio descendente
            const ordenesArray = Object.values(ordenesPreviasCompletas).sort((a, b) => {
                const numA = parseInt(a.folio.split('-')[2]);
                const numB = parseInt(b.folio.split('-')[2]);
                return numB - numA;
            });
            
            ordenesArray.forEach(orden => {
                const card = document.createElement('div');
                card.className = `orden-card ${orden.tipo === 'correctivo' ? 'correctivo' : ''}`;
                
                const detalles = orden.tipo === 'preventivo' ? `
                    <div class="orden-detail"><strong>Equipo:</strong> ${orden.equipo.nombre}</div>
                    <div class="orden-detail"><strong>Modelo:</strong> ${orden.equipo.modelo}</div>
                    <div class="orden-detail"><strong>Marca:</strong> ${orden.equipo.fabricante}</div>
                    <div class="orden-detail"><strong>Inventario:</strong> ${orden.equipo.inventario}</div>
                    <div class="orden-detail"><strong>Fecha:</strong> ${orden.fecha}</div>
                    <div class="orden-detail"><strong>Estado:</strong> ${orden.resultado || 'Completado'}</div>
                ` : `
                    <div class="orden-detail"><strong>Equipo:</strong> ${orden.equipo.nombre}</div>
                    <div class="orden-detail"><strong>Falla:</strong> ${orden.falla.sintomas}</div>
                    <div class="orden-detail"><strong>Prioridad:</strong> ${orden.falla.prioridad}</div>
                    <div class="orden-detail"><strong>Fecha:</strong> ${orden.fecha}</div>
                    <div class="orden-detail"><strong>Costo:</strong> ${orden.reparacion?.costoTotal || 'N/A'}</div>
                    <div class="orden-detail"><strong>Estado:</strong> ${orden.resultado || 'Completado'}</div>
                `;
                
                card.innerHTML = `
                    <div class="orden-info">
                        <div class="orden-header">
                            <div class="orden-folio">${orden.folio}</div>
                            <div class="orden-tipo-badge ${orden.tipo === 'preventivo' ? 'badge-preventivo' : 'badge-correctivo'}">
                                ${orden.tipo.toUpperCase()}
                            </div>
                        </div>
                        <div class="orden-details">
                            ${detalles}
                        </div>
                    </div>
                    <div class="orden-actions">
                        <button class="btn-download" onclick="descargarOrden('${orden.folio}')">📥 Descargar WORD</button>
                        <button class="btn-view" onclick="verOrden('${orden.folio}')">👁️ Ver Documento</button>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // Función para mostrar formulario de nueva orden
        function mostrarNuevaOrden(tipo) {
            document.getElementById('maintenanceTypeSelector').classList.add('hidden');
            document.getElementById('ordenServicioSection').classList.remove('hidden');
            document.getElementById('tipoMantenimiento').value = tipo;
            
            if (tipo === 'preventivo') {
                document.getElementById('tituloNuevaOrden').textContent = '📄 NUEVA ORDEN DE SERVICIO PREVENTIVO';
                document.getElementById('camposPreventivo').classList.remove('hidden');
                document.getElementById('camposCorrectivo').classList.add('hidden');
            } else {
                document.getElementById('tituloNuevaOrden').textContent = '🚨 NUEVA ORDEN DE SERVICIO CORRECTIVO';
                document.getElementById('camposPreventivo').classList.add('hidden');
                document.getElementById('camposCorrectivo').classList.remove('hidden');
            }

            // Actualizar paso activo
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
        }

        // Función para cargar datos del equipo seleccionado
        function cargarDatosEquipo() {
            const equipKey = document.getElementById('equipoSelect').value;
            if (!equipKey) {
                document.getElementById('equipoDetalles').classList.add('hidden');
                return;
            }
            
            const equip = equipmentDatabase[equipKey] || equiposPersonalizados[equipKey];
            if (!equip) return;
            
            document.getElementById('equipoNombre').value = equip.name;
            document.getElementById('equipoModelo').value = equip.model;
            document.getElementById('equipoFabricante').value = equip.brand;
            document.getElementById('equipoSerie').value = equip.serialNumber;
            document.getElementById('equipoInventario').value = equip.inventoryCode || '';
            document.getElementById('equipoUbicacion').value = equip.location;
            document.getElementById('equipoDetalles').classList.remove('hidden');
        }

        // Función para volver al inicio
        function volverAlInicio() {
            document.getElementById('maintenanceTypeSelector').classList.remove('hidden');
            document.getElementById('ordenServicioSection').classList.add('hidden');
            document.getElementById('vistaPreviaSection').classList.add('hidden');
            document.getElementById('ordenServicioForm').reset();
            document.getElementById('equipoDetalles').classList.add('hidden');
            
            // Resetear pasos
            document.getElementById('step1').classList.add('active');
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active', 'completed');
            document.getElementById('step3').classList.remove('active', 'completed');
        }

        // Función para volver al formulario desde vista previa
        function volverAFormulario() {
            document.getElementById('vistaPreviaSection').classList.add('hidden');
            document.getElementById('ordenServicioSection').classList.remove('hidden');
            
            // Actualizar pasos
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step2').classList.add('active');
        }

        // Manejar envío del formulario para vista previa
        document.getElementById('ordenServicioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generarVistaPrevia();
        });

        // Función para generar vista previa
        function generarVistaPrevia() {
            const tipo = document.getElementById('tipoMantenimiento').value;
            const fecha = new Date();
            const folio = tipo === 'preventivo' ? `MP-2025-${contadorOrdenes}` : `MC-2025-${contadorOrdenes}`;
            
            const equipKey = document.getElementById('equipoSelect').value;
            const equip = equipmentDatabase[equipKey] || equiposPersonalizados[equipKey];
            
            if (!equip) {
                alert('Por favor seleccione un equipo');
                return;
            }

            // Recopilar datos del formulario
            ordenActual = {
                tipo: tipo,
                folio: folio,
                fecha: fecha.toLocaleDateString('es-MX'),
                equipo: {
                    nombre: equip.name,
                    modelo: equip.model,
                    fabricante: equip.brand,
                    serie: equip.serialNumber,
                    inventario: equip.inventoryCode || '',
                    ubicacion: equip.location,
                    claseRiesgo: equip.risk
                },
                orden: {
                    tecnico: document.getElementById('tecnicoNombre').value,
                    cedula: document.getElementById('tecnicoCedula').value
                }
            };

            if (tipo === 'preventivo') {
                ordenActual.orden.tipoMantenimiento = document.getElementById('tipoMttoPreventivo').value;
                ordenActual.orden.prioridad = document.getElementById('prioridadPreventivo').value;
                ordenActual.orden.tiempoEstimado = document.getElementById('tiempoEstimado').value + ' horas';
                ordenActual.orden.fechaProgramada = document.getElementById('fechaProgramada').value;
                ordenActual.actividades = document.getElementById('actividadesPreventivo').value.split('\n').filter(a => a.trim());
                ordenActual.materialesUtilizados = document.getElementById('materialesPreventivo').value.split('\n').filter(m => m.trim());
            } else {
                ordenActual.falla = {
                    usuarioReporta: document.getElementById('usuarioReporta').value,
                    fechaIncidente: document.getElementById('fechaIncidente').value,
                    prioridad: document.getElementById('prioridadCorrectivo').value,
                    sintomas: document.getElementById('sintomas').value,
                    descripcion: document.getElementById('descripcionProblema').value
                };
            }

            // Mostrar vista previa
            mostrarVistaPrevia();
        }

        // Función para mostrar vista previa
        function mostrarVistaPrevia() {
            document.getElementById('ordenServicioSection').classList.add('hidden');
            document.getElementById('vistaPreviaSection').classList.remove('hidden');
            document.getElementById('folioPreview').textContent = `Folio: ${ordenActual.folio}`;

            // Actualizar pasos
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');

            // Generar HTML de vista previa
            let html = '';
            
            // Generar Orden de Servicio
            html += generarHTMLOrdenServicio(ordenActual);
            
            // Si es preventivo, agregar también el plan de mantenimiento
            if (ordenActual.tipo === 'preventivo') {
                html += '<hr style="margin: 40px 0; border: 2px solid #1e3c72;">';
                html += generarHTMLPlanMantenimiento(ordenActual);
            }
            
            document.getElementById('documentosPreview').innerHTML = html;
        }

        // Función para generar HTML de Orden de Servicio
        function generarHTMLOrdenServicio(orden) {
            let html = `
                <div class="doc-title">${orden.tipo === 'preventivo' ? 'ORDEN DE SERVICIO - MANTENIMIENTO PREVENTIVO' : 'ORDEN DE SERVICIO - MANTENIMIENTO CORRECTIVO'}</div>
                <div class="doc-subtitle">Folio ${orden.folio}</div>
                
                <div class="section-title">INFORMACIÓN DEL EQUIPO</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Número de Orden:</span>
                        <span class="info-value">${orden.folio}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha:</span>
                        <span class="info-value">${orden.fecha}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Equipo:</span>
                        <span class="info-value">${orden.equipo.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Modelo:</span>
                        <span class="info-value">${orden.equipo.modelo}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fabricante:</span>
                        <span class="info-value">${orden.equipo.fabricante}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">No. Serie:</span>
                        <span class="info-value">${orden.equipo.serie}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ubicación:</span>
                        <span class="info-value">${orden.equipo.ubicacion}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Código Inventario:</span>
                        <span class="info-value">${orden.equipo.inventario}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Técnico Responsable:</span>
                        <span class="info-value">${orden.orden.tecnico}</span>
                    </div>
                </div>
            `;

            if (orden.tipo === 'preventivo') {
                html += `
                    <div class="section-title">INFORMACIÓN DE LA ORDEN</div>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">Tipo de Mantenimiento:</span>
                            <span class="info-value">${orden.orden.tipoMantenimiento}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prioridad:</span>
                            <span class="info-value">${orden.orden.prioridad}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha Programada:</span>
                            <span class="info-value">${orden.orden.fechaProgramada}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tiempo Estimado:</span>
                            <span class="info-value">${orden.orden.tiempoEstimado}</span>
                        </div>
                    </div>
                `;
                
                // Agregar parámetros si existen
                if (orden.parametros && Object.keys(orden.parametros).length > 0) {
                    html += `
                    <div class="section-title">PARÁMETROS DE VERIFICACIÓN Y MEDICIONES</div>
                    <div class="info-section">
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr style="background: #1e3c72; color: white;">
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Parámetro</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Valor Medido</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Especificación</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    const paramLabels = {
                        'voltaje': { label: 'Voltaje de entrada', spec: '220V ±10%' },
                        'corrienteFuga': { label: 'Corriente de fuga', spec: '≤0.5 mA' },
                        'resistenciaTierra': { label: 'Resistencia a tierra', spec: '≤0.2 Ω' },
                        'frecuenciaUS': { label: 'Frecuencia ultrasonido', spec: '1MHz ±5%' },
                        'potenciaMax': { label: 'Potencia máxima ultrasonido', spec: '3W/cm²' },
                        'capacidadElevacion': { label: 'Capacidad elevación máxima', spec: '180 kg' },
                        'tiempoElevacion': { label: 'Tiempo elevación completa', spec: '15-20 seg' },
                        'corrienteCanal1': { label: 'Corriente Canal 1', spec: '0-150 mA' },
                        'corrienteCanal2': { label: 'Corriente Canal 2', spec: '0-150 mA' },
                        'magnificacionMax': { label: 'Magnificación máxima', spec: '39x' },
                        'distanciaFocal': { label: 'Distancia focal apocromática', spec: '200-500 mm' },
                        'magnificacionMin': { label: 'Magnificación mínima', spec: '6.3x ±5%' }
                    };
                    
                    Object.keys(orden.parametros).forEach(key => {
                        const paramInfo = paramLabels[key] || { label: key, spec: 'N/A' };
                        html += `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${paramInfo.label}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold;">${orden.parametros[key]}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${paramInfo.spec}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center; color: #28a745; font-weight: bold;">✓ OK</td>
                                </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <p style="margin-top: 10px; color: #28a745; font-weight: bold;">
                            ✓ Todos los parámetros dentro de especificaciones según normativa COFEPRIS
                        </p>
                    </div>
                    `;
                }
                
                html += `
                    <div class="section-title">ACTIVIDADES PROGRAMADAS</div>
                    <div class="info-section">
                        <ul class="activities-list">
                            ${orden.actividades.map(act => `<li>${act}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${orden.materialesUtilizados && orden.materialesUtilizados.length > 0 ? `
                    <div class="section-title">MATERIALES NECESARIOS</div>
                    <div class="info-section">
                        <ul class="activities-list">
                            ${orden.materialesUtilizados.map(mat => `<li>${mat}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                `;
            } else {
                html += `
                    <div class="section-title correctivo">INFORMACIÓN DE LA FALLA</div>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">Usuario Reportante:</span>
                            <span class="info-value">${orden.falla.usuarioReporta}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha/Hora del Incidente:</span>
                            <span class="info-value">${orden.falla.fechaIncidente}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prioridad:</span>
                            <span class="info-value">${orden.falla.prioridad}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Síntomas:</span>
                            <span class="info-value">${orden.falla.sintomas}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Descripción del Problema:</span>
                            <span class="info-value">${orden.falla.descripcion}</span>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // Función para generar HTML de Plan de Mantenimiento (solo para preventivo)
        function generarHTMLPlanMantenimiento(orden) {
            return `
                <div class="doc-title">PLAN DE MANTENIMIENTO - RUTINA DE ACTIVIDADES</div>
                <div class="doc-subtitle">Asociado a Orden ${orden.folio}</div>
                
                <div class="section-title">DATOS DEL MANTENIMIENTO</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Equipo:</span>
                        <span class="info-value">${orden.equipo.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tipo de Mantenimiento:</span>
                        <span class="info-value">${orden.orden.tipoMantenimiento}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha Programada:</span>
                        <span class="info-value">${orden.orden.fechaProgramada}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tiempo Estimado:</span>
                        <span class="info-value">${orden.orden.tiempoEstimado}</span>
                    </div>
                </div>
                
                <div class="section-title">CHECKLIST DE ACTIVIDADES</div>
                <div class="info-section">
                    <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                        <thead>
                            <tr>
                                <th style="border: 1px solid #ccc; padding: 8px; background: #e8f4f8;">#</th>
                                <th style="border: 1px solid #ccc; padding: 8px; background: #e8f4f8;">Actividad</th>
                                <th style="border: 1px solid #ccc; padding: 8px; background: #e8f4f8;">Realizado</th>
                                <th style="border: 1px solid #ccc; padding: 8px; background: #e8f4f8;">Observaciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${orden.actividades.map((act, idx) => `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${idx + 1}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${act}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">☐</td>
                                    <td style="border: 1px solid #ccc; padding: 8px;">_____________</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                ${orden.materialesUtilizados && orden.materialesUtilizados.length > 0 ? `
                <div class="section-title">MATERIALES Y HERRAMIENTAS</div>
                <div class="info-section">
                    <ul class="activities-list">
                        ${orden.materialesUtilizados.map(mat => `<li>${mat}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div class="section-title">OBSERVACIONES Y HALLAZGOS</div>
                <div class="info-section">
                    <div style="min-height: 80px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">
                        ________________________________________________
                    </div>
                </div>
                
                <div class="section-title">FIRMAS Y VALIDACIÓN</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div style="border: 1px solid #ccc; padding: 15px; text-align: center;">
                        <div style="font-weight: bold; color: #1e3c72; margin-bottom: 10px;">TÉCNICO EJECUTOR</div>
                        <div>Nombre: ${orden.orden.tecnico}</div>
                        <div style="margin-top: 40px;">Firma: _________________</div>
                    </div>
                    <div style="border: 1px solid #ccc; padding: 15px; text-align: center;">
                        <div style="font-weight: bold; color: #1e3c72; margin-bottom: 10px;">SUPERVISOR</div>
                        <div>Nombre: _________________</div>
                        <div style="margin-top: 40px;">Firma: _________________</div>
                    </div>
                </div>
            `;
        }

        // Función para guardar orden
        function guardarOrden() {
            // Agregar orden a la base de datos
            ordenesPreviasCompletas[ordenActual.folio] = ordenActual;
            
            // Guardar en localStorage
            guardarOrdenesEnStorage();
            
            // Incrementar contador
            contadorOrdenes++;
            
            // Recargar órdenes previas
            cargarOrdenesPrevias();
            
            // Mostrar mensaje de éxito
            alert(`✅ Orden ${ordenActual.folio} guardada exitosamente!`);
            
            // Volver al inicio
            volverAlInicio();
        }

        // Función para ver orden en modal
        function verOrden(folio) {
            const orden = ordenesPreviasCompletas[folio];
            if (!orden) return;
            
            const modal = document.getElementById('docModal');
            const modalTitle = document.getElementById('modalTitle');
            const content = document.getElementById('documentContent');
            
            modalTitle.textContent = `${orden.tipo === 'preventivo' ? 'MANTENIMIENTO PREVENTIVO' : 'MANTENIMIENTO CORRECTIVO'} - ${folio}`;
            
            let html = generarHTMLVisualizacionCompleta(orden);
            content.innerHTML = html;
            modal.style.display = 'block';
        }

        // Función para generar HTML de visualización completa
        function generarHTMLVisualizacionCompleta(orden) {
            let html = `
                <div class="doc-title">${orden.tipo === 'preventivo' ? 'MANTENIMIENTO PREVENTIVO' : 'MANTENIMIENTO CORRECTIVO'}</div>
                <div class="doc-subtitle">Orden de Servicio ${orden.folio}</div>
                
                <div class="section-title">INFORMACIÓN DEL EQUIPO</div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Número de Orden:</span>
                        <span class="info-value">${orden.folio}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha:</span>
                        <span class="info-value">${orden.fecha}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Equipo:</span>
                        <span class="info-value">${orden.equipo.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Modelo:</span>
                        <span class="info-value">${orden.equipo.modelo}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fabricante:</span>
                        <span class="info-value">${orden.equipo.fabricante}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">No. Serie:</span>
                        <span class="info-value">${orden.equipo.serie}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Ubicación:</span>
                        <span class="info-value">${orden.equipo.ubicacion}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Código Inventario:</span>
                        <span class="info-value">${orden.equipo.inventario}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Clase de Riesgo:</span>
                        <span class="info-value">${orden.equipo.claseRiesgo}</span>
                    </div>
                </div>
            `;

            if (orden.tipo === 'preventivo') {
                html += `
                    <div class="section-title">INFORMACIÓN DE LA ORDEN</div>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">Tipo de Mantenimiento:</span>
                            <span class="info-value">${orden.orden.tipoMantenimiento || 'Preventivo'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prioridad:</span>
                            <span class="info-value">${orden.orden.prioridad || 'Media'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Técnico Asignado:</span>
                            <span class="info-value">${orden.orden.tecnico}</span>
                        </div>
                `;

                if (orden.orden.supervisor) {
                    html += `
                        <div class="info-row">
                            <span class="info-label">Supervisor:</span>
                            <span class="info-value">${orden.orden.supervisor}</span>
                        </div>
                    `;
                }

                if (orden.orden.tiempoEstimado) {
                    html += `
                        <div class="info-row">
                            <span class="info-label">Tiempo Estimado:</span>
                            <span class="info-value">${orden.orden.tiempoEstimado}</span>
                        </div>
                    `;
                }
                
                html += '</div>';
                
                // Agregar parámetros si existen
                if (orden.parametros && Object.keys(orden.parametros).length > 0) {
                    html += `
                    <div class="section-title">PARÁMETROS DE VERIFICACIÓN Y MEDICIONES</div>
                    <div class="info-section">
                        <table style="width: 100%; border-collapse: collapse; margin: 10px 0;">
                            <thead>
                                <tr style="background: #1e3c72; color: white;">
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: left;">Parámetro</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Valor Medido</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Especificación</th>
                                    <th style="border: 1px solid #ccc; padding: 10px; text-align: center;">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    const paramLabels = {
                        'voltaje': { label: 'Voltaje de entrada', spec: '220V ±10%' },
                        'corrienteFuga': { label: 'Corriente de fuga', spec: '≤0.5 mA' },
                        'resistenciaTierra': { label: 'Resistencia a tierra', spec: '≤0.2 Ω' },
                        'frecuenciaUS': { label: 'Frecuencia ultrasonido', spec: '1MHz ±5%' },
                        'potenciaMax': { label: 'Potencia máxima ultrasonido', spec: '3W/cm²' },
                        'capacidadElevacion': { label: 'Capacidad elevación máxima', spec: '180 kg' },
                        'tiempoElevacion': { label: 'Tiempo elevación completa', spec: '15-20 seg' },
                        'corrienteCanal1': { label: 'Corriente Canal 1', spec: '0-150 mA' },
                        'corrienteCanal2': { label: 'Corriente Canal 2', spec: '0-150 mA' },
                        'magnificacionMax': { label: 'Magnificación máxima', spec: '39x' },
                        'distanciaFocal': { label: 'Distancia focal apocromática', spec: '200-500 mm' },
                        'magnificacionMin': { label: 'Magnificación mínima', spec: '6.3x ±5%' }
                    };
                    
                    Object.keys(orden.parametros).forEach(key => {
                        const paramInfo = paramLabels[key] || { label: key, spec: 'N/A' };
                        html += `
                                <tr>
                                    <td style="border: 1px solid #ccc; padding: 8px;">${paramInfo.label}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center; font-weight: bold; color: #1e3c72;">${orden.parametros[key]}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center;">${paramInfo.spec}</td>
                                    <td style="border: 1px solid #ccc; padding: 8px; text-align: center; color: #28a745; font-weight: bold;">✓ OK</td>
                                </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                        <p style="margin-top: 10px; color: #28a745; font-weight: bold;">
                            ✓ Todos los parámetros dentro de especificaciones según normativa COFEPRIS
                        </p>
                    </div>
                    `;
                }
                
                // Actividades
                if (orden.actividades && orden.actividades.length > 0) {
                    html += `
                        <div class="section-title">ACTIVIDADES REALIZADAS</div>
                        <div class="info-section">
                            <ul class="activities-list">
                                ${orden.actividades.map(act => `<li>${act}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Materiales Utilizados
                if (orden.materialesUtilizados && orden.materialesUtilizados.length > 0) {
                    html += `
                        <div class="section-title">MATERIALES Y COMPONENTES UTILIZADOS</div>
                        <div class="info-section">
                            <ul class="activities-list">
                                ${orden.materialesUtilizados.map(mat => `<li>${mat}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                // Observaciones
                if (orden.observaciones) {
                    html += `
                        <div class="section-title">OBSERVACIONES Y HALLAZGOS</div>
                        <div class="info-section">
                            <p>${orden.observaciones}</p>
                        </div>
                    `;
                }
                
                // Resultado
                if (orden.resultado) {
                    html += `
                        <div class="section-title">RESULTADO</div>
                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Estado:</span>
                                <span class="info-value" style="color: #28a745; font-weight: bold;">${orden.resultado}</span>
                            </div>
                    `;

                    if (orden.proximaFecha) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Próxima Fecha Programada:</span>
                                <span class="info-value">${orden.proximaFecha}</span>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
            } else {
                // Correctivo
                html += `
                    <div class="section-title correctivo">INFORMACIÓN DE LA FALLA</div>
                    <div class="info-section">
                        <div class="info-row">
                            <span class="info-label">Usuario Reportante:</span>
                            <span class="info-value">${orden.falla.usuarioReporta}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fecha/Hora del Incidente:</span>
                            <span class="info-value">${orden.falla.fechaIncidente}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Prioridad:</span>
                            <span class="info-value">${orden.falla.prioridad}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Descripción del Problema:</span>
                            <span class="info-value">${orden.falla.descripcion}</span>
                        </div>
                    </div>
                `;
                
                // Diagnóstico
                if (orden.diagnostico) {
                    html += `
                        <div class="section-title correctivo">DIAGNÓSTICO TÉCNICO</div>
                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Técnico Asignado:</span>
                                <span class="info-value">${orden.diagnostico.tecnico}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha Inicio Diagnóstico:</span>
                                <span class="info-value">${orden.diagnostico.fechaInicio}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Causa Raíz:</span>
                                <span class="info-value">${orden.diagnostico.causaRaiz}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Reparación
                if (orden.reparacion) {
                    html += `
                        <div class="section-title correctivo">REGISTRO DE REPARACIÓN</div>
                        <div class="info-section">
                            <div class="info-row">
                                <span class="info-label">Fecha/Hora Inicio:</span>
                                <span class="info-value">${orden.reparacion.fechaInicio}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha/Hora Fin:</span>
                                <span class="info-value">${orden.reparacion.fechaFin}</span>
                            </div>
                    `;
                    
                    if (orden.reparacion.procedimientos) {
                        html += '<p style="margin-top: 15px;"><strong>Procedimientos Ejecutados:</strong></p><ul class="activities-list">';
                        orden.reparacion.procedimientos.forEach(proc => {
                            html += `<li>${proc}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (orden.reparacion.materialesUtilizados) {
                        html += '<p style="margin-top: 15px;"><strong>Materiales Utilizados:</strong></p><ul class="activities-list">';
                        orden.reparacion.materialesUtilizados.forEach(mat => {
                            html += `<li>${mat}</li>`;
                        });
                        html += '</ul>';
                    }
                    
                    if (orden.reparacion.componenteDefectuoso) {
                        html += `
                            <div class="info-row" style="margin-top: 15px;">
                                <span class="info-label">Componente Defectuoso:</span>
                                <span class="info-value">${orden.reparacion.componenteDefectuoso}</span>
                            </div>
                        `;
                    }
                    
                    if (orden.reparacion.componenteNuevo) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Componente Nuevo:</span>
                                <span class="info-value">${orden.reparacion.componenteNuevo}</span>
                            </div>
                        `;
                    }
                    
                    if (orden.reparacion.costoTotal) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Costo Total:</span>
                                <span class="info-value">${orden.reparacion.costoTotal}</span>
                            </div>
                        `;
                    }
                    
                    if (orden.reparacion.tiempoFueraServicio) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Tiempo Fuera de Servicio:</span>
                                <span class="info-value">${orden.reparacion.tiempoFueraServicio}</span>
                            </div>
                        `;
                    }
                    
                    if (orden.resultado) {
                        html += `
                            <div class="info-row">
                                <span class="info-label">Resultado:</span>
                                <span class="info-value" style="color: #28a745; font-weight: bold;">${orden.resultado}</span>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
            }

            return html;
        }

        // Función para cerrar modal
        function cerrarModal() {
            document.getElementById('docModal').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modals = ['docModal', 'addEquipmentModal', 'editEquipmentModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Función para descargar orden
        function descargarOrden(folio) {
            const orden = ordenesPreviasCompletas[folio];
            if (orden) {
                descargarOrdenWORD(orden);
            }
        }

        // FUNCIÓN DE DESCARGA WORD (del documento 1 que SÍ FUNCIONA)
        async function descargarOrdenWORD(orden) {
            try {
                // Verificar que docx esté disponible
                if (typeof docx === 'undefined') {
                    alert('Error: La biblioteca docx no está cargada correctamente. Por favor, recarga la página.');
                    return;
                }
                
                const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, HeadingLevel, Packer } = docx;
                
                // Crear párrafos del documento
                const paragraphs = [];
                
                // Título
                paragraphs.push(
                    new Paragraph({
                        text: `BITÁCORA DE MANTENIMIENTO ${orden.tipo.toUpperCase()}`,
                        heading: HeadingLevel.HEADING_1,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    })
                );
                
                // Subtítulo
                paragraphs.push(
                    new Paragraph({
                        text: "Hospital UVM - Gestión de Equipos Médicos",
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 100 }
                    })
                );
                
                paragraphs.push(
                    new Paragraph({
                        text: `Folio: ${orden.folio}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 400 }
                    })
                );
                
                // Sección I: Identificación del equipo
                paragraphs.push(
                    new Paragraph({
                        text: "I. IDENTIFICACIÓN DEL EQUIPO MÉDICO",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 200, after: 200 }
                    })
                );
                
                paragraphs.push(new Paragraph({ text: `Equipo: ${orden.equipo.nombre}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `Fabricante: ${orden.equipo.fabricante}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `Modelo: ${orden.equipo.modelo}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `No. Serie: ${orden.equipo.serie}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `Ubicación: ${orden.equipo.ubicacion}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `No. Inventario: ${orden.equipo.inventario}`, spacing: { after: 200 } }));
                
                // Sección II: Información del mantenimiento
                paragraphs.push(
                    new Paragraph({
                        text: "II. INFORMACIÓN DEL MANTENIMIENTO",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 200, after: 200 }
                    })
                );
                
                paragraphs.push(new Paragraph({ text: `Tipo: ${orden.tipo.toUpperCase()}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `Fecha: ${orden.fecha}`, spacing: { after: 100 } }));
                paragraphs.push(new Paragraph({ text: `Técnico Responsable: ${orden.orden.tecnico}`, spacing: { after: 100 } }));
                if (orden.orden.cedula) {
                    paragraphs.push(new Paragraph({ text: `Cédula Profesional: ${orden.orden.cedula}`, spacing: { after: 100 } }));
                }
                if (orden.orden.tiempoEstimado) {
                    paragraphs.push(new Paragraph({ text: `Duración: ${orden.orden.tiempoEstimado}`, spacing: { after: 200 } }));
                }
                
                // Sección de Parámetros de Verificación (requerido por COFEPRIS)
                if (orden.parametros && Object.keys(orden.parametros).length > 0) {
                    paragraphs.push(
                        new Paragraph({
                            text: "III. PARÁMETROS DE VERIFICACIÓN Y MEDICIONES",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 300, after: 200 }
                        })
                    );
                    
                    // Crear tabla de parámetros
                    const paramRows = [];
                    
                    // Encabezado de tabla
                    paramRows.push(
                        new TableRow({
                            children: [
                                new TableCell({
                                    children: [new Paragraph({ text: "Parámetro", bold: true })],
                                    width: { size: 40, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({
                                    children: [new Paragraph({ text: "Valor Medido", bold: true })],
                                    width: { size: 30, type: WidthType.PERCENTAGE }
                                }),
                                new TableCell({
                                    children: [new Paragraph({ text: "Especificación", bold: true })],
                                    width: { size: 30, type: WidthType.PERCENTAGE }
                                })
                            ]
                        })
                    );
                    
                    // Mapeo de nombres técnicos a nombres legibles con especificaciones
                    const paramLabels = {
                        'voltaje': { label: 'Voltaje de entrada', spec: '220V ±10%' },
                        'corrienteFuga': { label: 'Corriente de fuga', spec: '≤0.5 mA' },
                        'resistenciaTierra': { label: 'Resistencia a tierra', spec: '≤0.2 Ω' },
                        'frecuenciaUS': { label: 'Frecuencia ultrasonido', spec: '1MHz ±5%' },
                        'potenciaMax': { label: 'Potencia máxima ultrasonido', spec: '3W/cm²' },
                        'capacidadElevacion': { label: 'Capacidad elevación máxima', spec: '180 kg' },
                        'tiempoElevacion': { label: 'Tiempo elevación completa', spec: '15-20 seg' },
                        'corrienteCanal1': { label: 'Corriente Canal 1', spec: '0-150 mA' },
                        'corrienteCanal2': { label: 'Corriente Canal 2', spec: '0-150 mA' },
                        'magnificacionMax': { label: 'Magnificación máxima', spec: '39x' },
                        'distanciaFocal': { label: 'Distancia focal apocromática', spec: '200-500 mm' },
                        'magnificacionMin': { label: 'Magnificación mínima', spec: '6.3x ±5%' }
                    };
                    
                    // Agregar filas de parámetros
                    Object.keys(orden.parametros).forEach(key => {
                        const paramInfo = paramLabels[key] || { label: key, spec: 'N/A' };
                        paramRows.push(
                            new TableRow({
                                children: [
                                    new TableCell({
                                        children: [new Paragraph(paramInfo.label)]
                                    }),
                                    new TableCell({
                                        children: [new Paragraph(orden.parametros[key])]
                                    }),
                                    new TableCell({
                                        children: [new Paragraph(paramInfo.spec)]
                                    })
                                ]
                            })
                        );
                    });
                    
                    // Agregar tabla al documento
                    const paramTable = new Table({
                        rows: paramRows,
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    });
                    
                    paragraphs.push(new Paragraph({ children: [] }));
                    
                    // Como no podemos agregar Table directamente, usaremos párrafos formateados
                    paragraphs.push(new Paragraph({ 
                        text: "Parámetro                           | Valor Medido        | Especificación",
                        spacing: { after: 100 }
                    }));
                    paragraphs.push(new Paragraph({ 
                        text: "─────────────────────────────────────────────────────────────────────",
                        spacing: { after: 100 }
                    }));
                    
                    Object.keys(orden.parametros).forEach(key => {
                        const paramInfo = paramLabels[key] || { label: key, spec: 'N/A' };
                        const labelPadded = (paramInfo.label + '                                        ').substring(0, 35);
                        const valuePadded = (orden.parametros[key] + '                    ').substring(0, 20);
                        paragraphs.push(new Paragraph({ 
                            text: `${labelPadded}| ${valuePadded}| ${paramInfo.spec}`,
                            spacing: { after: 50 }
                        }));
                    });
                    
                    paragraphs.push(new Paragraph({ 
                        text: "─────────────────────────────────────────────────────────────────────",
                        spacing: { before: 50, after: 200 }
                    }));
                    
                    paragraphs.push(new Paragraph({ 
                        text: "✓ Todos los parámetros dentro de especificaciones según normativa COFEPRIS",
                        spacing: { after: 200 }
                    }));
                }
                
                // Contenido específico según tipo
                if (orden.tipo === 'preventivo') {
                    // Actividades
                    const actividadesSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "IV" : "III";
                    paragraphs.push(
                        new Paragraph({
                            text: `${actividadesSection}. ACTIVIDADES REALIZADAS`,
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 200, after: 200 }
                        })
                    );
                    
                    if (orden.actividades) {
                        orden.actividades.forEach(act => {
                            paragraphs.push(new Paragraph({ text: `✓ ${act}`, spacing: { after: 100 } }));
                        });
                    }
                    
                    // Observaciones
                    if (orden.observaciones) {
                        const observacionesSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "V" : "IV";
                        paragraphs.push(
                            new Paragraph({
                                text: `${observacionesSection}. OBSERVACIONES Y RECOMENDACIONES`,
                                heading: HeadingLevel.HEADING_2,
                                spacing: { before: 300, after: 200 }
                            })
                        );
                        
                        paragraphs.push(new Paragraph({ text: orden.observaciones, spacing: { after: 100 } }));
                        if (orden.proximaFecha) {
                            paragraphs.push(new Paragraph({ 
                                text: `Próximo Mantenimiento: ${orden.proximaFecha}`, 
                                spacing: { after: 200 } 
                            }));
                        }
                    }
                    
                } else {
                    // Contenido para mantenimiento correctivo
                    const fallaSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "IV" : "III";
                    paragraphs.push(
                        new Paragraph({
                            text: `${fallaSection}. INFORMACIÓN DE LA FALLA`,
                            heading: HeadingLevel.HEADING_2,
                            spacing: { before: 200, after: 200 }
                        })
                    );
                    
                    paragraphs.push(new Paragraph({ text: `Usuario Reportante: ${orden.falla.usuarioReporta}`, spacing: { after: 100 } }));
                    paragraphs.push(new Paragraph({ text: `Fecha/Hora: ${orden.falla.fechaIncidente}`, spacing: { after: 100 } }));
                    paragraphs.push(new Paragraph({ text: `Prioridad: ${orden.falla.prioridad}`, spacing: { after: 100 } }));
                    paragraphs.push(new Paragraph({ text: `Descripción: ${orden.falla.descripcion}`, spacing: { after: 200 } }));
                    
                    if (orden.diagnostico) {
                        const diagnosticoSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "V" : "IV";
                        paragraphs.push(
                            new Paragraph({
                                text: `${diagnosticoSection}. DIAGNÓSTICO`,
                                heading: HeadingLevel.HEADING_2,
                                spacing: { before: 300, after: 200 }
                            })
                        );
                        
                        paragraphs.push(new Paragraph({ text: `Causa Raíz: ${orden.diagnostico.causaRaiz}`, spacing: { after: 100 } }));
                        paragraphs.push(new Paragraph({ text: `Fecha Inicio: ${orden.diagnostico.fechaInicio}`, spacing: { after: 200 } }));
                    }
                    
                    if (orden.reparacion) {
                        const reparacionSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "VI" : "V";
                        paragraphs.push(
                            new Paragraph({
                                text: `${reparacionSection}. REPARACIÓN`,
                                heading: HeadingLevel.HEADING_2,
                                spacing: { before: 300, after: 200 }
                            })
                        );
                        
                        if (orden.orden.tiempoEstimado) {
                            paragraphs.push(new Paragraph({ text: `Duración: ${orden.orden.tiempoEstimado}`, spacing: { after: 100 } }));
                        }
                        
                        if (orden.reparacion.procedimientos) {
                            paragraphs.push(new Paragraph({ text: "Procedimientos:", bold: true, spacing: { after: 100 } }));
                            orden.reparacion.procedimientos.forEach(p => {
                                paragraphs.push(new Paragraph({ text: `• ${p}`, spacing: { after: 50 } }));
                            });
                        }
                        
                        if (orden.reparacion.componenteDefectuoso) {
                            paragraphs.push(new Paragraph({ text: `Componente Defectuoso: ${orden.reparacion.componenteDefectuoso}`, spacing: { before: 100, after: 100 } }));
                        }
                        if (orden.reparacion.componenteNuevo) {
                            paragraphs.push(new Paragraph({ text: `Componente Nuevo: ${orden.reparacion.componenteNuevo}`, spacing: { after: 200 } }));
                        }
                    }
                    
                    if (orden.reparacion && orden.reparacion.costoTotal) {
                        const costosSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "VII" : "VI";
                        paragraphs.push(
                            new Paragraph({
                                text: `${costosSection}. COSTOS`,
                                heading: HeadingLevel.HEADING_2,
                                spacing: { before: 300, after: 200 }
                            })
                        );
                        
                        paragraphs.push(new Paragraph({ text: `Costo Total: ${orden.reparacion.costoTotal}`, spacing: { after: 100 } }));
                        if (orden.reparacion.tiempoFueraServicio) {
                            paragraphs.push(new Paragraph({ text: `Tiempo Fuera de Servicio: ${orden.reparacion.tiempoFueraServicio}`, spacing: { after: 200 } }));
                        }
                    }
                    
                    if (orden.resultado) {
                        const resultadoSection = orden.parametros && Object.keys(orden.parametros).length > 0 ? "VIII" : "VII";
                        paragraphs.push(
                            new Paragraph({
                                text: `${resultadoSection}. RESULTADO`,
                                heading: HeadingLevel.HEADING_2,
                                spacing: { before: 300, after: 200 }
                            })
                        );
                        
                        paragraphs.push(new Paragraph({ text: orden.resultado, spacing: { after: 200 } }));
                    }
                }
                
                // Firmas
                paragraphs.push(
                    new Paragraph({
                        text: "FIRMAS",
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 400, after: 200 }
                    })
                );
                
                paragraphs.push(new Paragraph({ text: `TÉCNICO RESPONSABLE: ${orden.orden.tecnico}`, spacing: { after: 100 } }));
                if (orden.orden.cedula) {
                    paragraphs.push(new Paragraph({ text: `Cédula: ${orden.orden.cedula}`, spacing: { after: 100 } }));
                }
                paragraphs.push(new Paragraph({ text: "Firma: _________________", spacing: { after: 300 } }));
                paragraphs.push(new Paragraph({ text: "SUPERVISOR: _________________", spacing: { after: 300 } }));
                paragraphs.push(new Paragraph({ text: "USUARIO FINAL: _________________", spacing: { after: 300 } }));
                
                // Crear documento
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: paragraphs
                    }]
                });
                
                // Generar y descargar
                const blob = await Packer.toBlob(doc);
                saveAs(blob, `${orden.folio}_Bitacora.docx`);
                
                alert('✅ Documento Word generado exitosamente');
                
            } catch (error) {
                console.error('Error detallado:', error);
                alert(`Error al generar el documento WORD: ${error.message}\n\nPor favor, verifica la consola del navegador para más detalles.`);
            }
        }

        // FUNCIONES PARA GESTIÓN DE EQUIPOS

        // Abrir modal agregar equipo
        function abrirModalAgregarEquipo() {
            document.getElementById('addEquipmentModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Cerrar modal agregar equipo
        function cerrarModalAgregarEquipo() {
            document.getElementById('addEquipmentModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('newEquipmentForm').reset();
        }

        // Funciones para listas dinámicas
        function addActivity() {
            const list = document.getElementById('activitiesList');
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <input type="text" placeholder="Agregar nueva actividad...">
                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
            `;
            list.appendChild(item);
        }

        function addMeasurement() {
            const list = document.getElementById('measurementsList');
            const item = document.createElement('div');
            item.className = 'list-item';
            item.style.display = 'grid';
            item.style.gridTemplateColumns = '2fr 1fr 1fr auto';
            item.style.gap = '10px';
            item.style.alignItems = 'center';
            item.innerHTML = `
                <input type="text" placeholder="Parámetro">
                <input type="text" placeholder="Especificación">
                <input type="text" placeholder="Unidad">
                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
            `;
            list.appendChild(item);
        }

        function addSymptom() {
            const list = document.getElementById('symptomsList');
            const item = document.createElement('div');
            item.className = 'list-item';
            item.innerHTML = `
                <input type="text" placeholder="Agregar nuevo síntoma...">
                <button type="button" class="remove-btn" onclick="removeListItem(this)">✕</button>
            `;
            list.appendChild(item);
        }

        function removeListItem(button) {
            button.parentElement.remove();
        }

        // Extraer datos de listas
        function extractListData(listId) {
            const list = document.getElementById(listId);
            const items = list.querySelectorAll('.list-item input[type="text"]');
            return Array.from(items).map(input => input.value.trim()).filter(value => value !== '');
        }

        // Extraer datos de mediciones
        function extractMeasurementData() {
            const list = document.getElementById('measurementsList');
            const items = list.querySelectorAll('.list-item');
            return Array.from(items).map(item => {
                const inputs = item.querySelectorAll('input[type="text"]');
                if (inputs.length >= 3) {
                    return {
                        param: inputs[0].value.trim(),
                        spec: inputs[1].value.trim(),
                        unit: inputs[2].value.trim()
                    };
                }
                return null;
            }).filter(item => item && item.param && item.spec);
        }

        // Guardar nuevo equipo
        function guardarNuevoEquipo() {
            const name = document.getElementById('equipName').value.trim();
            const brand = document.getElementById('equipBrand').value.trim();
            const model = document.getElementById('equipModel').value.trim();
            const serial = document.getElementById('equipSerial').value.trim();
            const inventory = document.getElementById('equipInventory').value.trim();
            const location = document.getElementById('equipLocation').value.trim();
            
            if (!name || !brand || !model || !serial || !inventory || !location) {
                alert('Por favor complete los campos obligatorios: Nombre, Marca, Modelo, Número de Serie, Código de Inventario y Ubicación.');
                return;
            }
            
            const equipId = name.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_custom_' + Date.now();
            
            if (equipmentDatabase[equipId] || equiposPersonalizados[equipId]) {
                alert('Ya existe un equipo con ese nombre. Por favor use un nombre diferente.');
                return;
            }
            
            const newEquipment = {
                name: name,
                brand: brand,
                model: model,
                serialNumber: serial,
                inventoryCode: inventory,
                location: location,
                specialty: document.getElementById('equipSpecialty').value,
                risk: document.getElementById('equipRisk').value,
                preventivo: {
                    activities: extractListData('activitiesList'),
                    measurements: extractMeasurementData()
                },
                correctivo: {
                    commonSymptoms: extractListData('symptomsList')
                }
            };
            
            if (newEquipment.preventivo.activities.length === 0) {
                alert('Debe agregar al menos una actividad de mantenimiento preventivo.');
                return;
            }
            
            if (newEquipment.correctivo.commonSymptoms.length === 0) {
                alert('Debe agregar al menos un síntoma común.');
                return;
            }
            
            equiposPersonalizados[equipId] = newEquipment;
            guardarEquiposPersonalizados();
            actualizarSelectoresEquipo();
            actualizarContadorEquipos();
            
            cerrarModalAgregarEquipo();
            alert(`✅ Equipo "${name}" agregado exitosamente!\n\nYa puede seleccionarlo en la lista de equipos.`);
        }

        // Abrir modal editar equipo
        function abrirModalEditarEquipo() {
            document.getElementById('editEquipmentModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Actualizar select
            const select = document.getElementById('editEquipmentSelect');
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Agregar equipos predeterminados
            Object.keys(equipmentDatabase).forEach(key => {
                const equip = equipmentDatabase[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${equip.name} - ${equip.brand} ${equip.model}`;
                select.appendChild(option);
            });
            
            // Agregar equipos personalizados
            Object.keys(equiposPersonalizados).forEach(key => {
                const equip = equiposPersonalizados[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${equip.name} - ${equip.brand} ${equip.model}`;
                option.className = 'custom-option';
                select.appendChild(option);
            });
        }

        // Cerrar modal editar equipo
        function cerrarModalEditarEquipo() {
            document.getElementById('editEquipmentModal').style.display = 'none';
            document.getElementById('editEquipmentForm').classList.add('hidden');
            document.getElementById('editEquipmentSelect').value = '';
            document.body.style.overflow = 'auto';
        }

        // Cargar equipo para editar
        function cargarEquipoParaEditar() {
            const select = document.getElementById('editEquipmentSelect');
            const equipmentKey = select.value;
            
            if (!equipmentKey) {
                document.getElementById('editEquipmentForm').classList.add('hidden');
                return;
            }
            
            const equipment = equipmentDatabase[equipmentKey] || equiposPersonalizados[equipmentKey];
            
            if (!equipment) {
                alert('Error: No se encontró la información del equipo seleccionado.');
                return;
            }
            
            document.getElementById('editEquipmentForm').classList.remove('hidden');
            
            document.getElementById('editEquipName').value = equipment.name;
            document.getElementById('editEquipBrand').value = equipment.brand;
            document.getElementById('editEquipModel').value = equipment.model;
            document.getElementById('editEquipSerial').value = equipment.serialNumber || '';
            document.getElementById('editEquipInventory').value = equipment.inventoryCode || '';
            document.getElementById('editEquipLocation').value = equipment.location;
            document.getElementById('editEquipSpecialty').value = equipment.specialty;
            document.getElementById('editEquipRisk').value = equipment.risk;
        }

        // Guardar equipo editado
        function guardarEquipoEditado() {
            const select = document.getElementById('editEquipmentSelect');
            const equipmentKey = select.value;
            
            if (!equipmentKey) {
                alert('Por favor seleccione un equipo para editar.');
                return;
            }
            
            const name = document.getElementById('editEquipName').value.trim();
            const brand = document.getElementById('editEquipBrand').value.trim();
            const model = document.getElementById('editEquipModel').value.trim();
            
            if (!name || !brand || !model) {
                alert('Por favor complete los campos obligatorios: Nombre, Marca y Modelo del equipo.');
                return;
            }
            
            let equipment;
            let isBaseEquipment = false;
            
            if (equipmentDatabase[equipmentKey]) {
                equipment = equipmentDatabase[equipmentKey];
                isBaseEquipment = true;
            } else if (equiposPersonalizados[equipmentKey]) {
                equipment = equiposPersonalizados[equipmentKey];
            } else {
                alert('Error: No se encontró el equipo seleccionado.');
                return;
            }
            
            equipment.name = name;
            equipment.brand = brand;
            equipment.model = model;
            equipment.serialNumber = document.getElementById('editEquipSerial').value.trim() || equipment.serialNumber;
            equipment.inventoryCode = document.getElementById('editEquipInventory').value.trim() || equipment.inventoryCode;
            equipment.location = document.getElementById('editEquipLocation').value.trim();
            equipment.specialty = document.getElementById('editEquipSpecialty').value;
            equipment.risk = document.getElementById('editEquipRisk').value;
            
            if (!isBaseEquipment) {
                guardarEquiposPersonalizados();
            }
            
            actualizarSelectoresEquipo();
            cerrarModalEditarEquipo();
            alert(`✅ Equipo "${name}" actualizado exitosamente!`);
        }
    </script>
</body>
</html>